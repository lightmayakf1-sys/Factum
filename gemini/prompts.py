"""Промпты для Gemini API: контекст оборудования, извлечение параметров и верификация."""


# =============================================================================
# ЭТАП 2: ОПРЕДЕЛЕНИЕ КОНТЕКСТА ОБОРУДОВАНИЯ
# =============================================================================

CONTEXT_SYSTEM_PROMPT = """Ты — ведущий технический аналитик проектного института. Тебе предоставлены
начальные страницы документов на единицу оборудования.

Определи:
1. equipment_type: Тип оборудования (токарный станок, компрессор, насос и т.д.)
2. equipment_name: Полное наименование/модель
3. purpose: Назначение (обработка металла, перекачка жидкости и т.д.)
4. subsystems: Список основных подсистем (электропривод, пневматика, гидравлика,
   охлаждение, ЧПУ и т.д.)
5. power_class: Ориентировочный класс мощности (бытовое <1кВт / лёгкое 1-10кВт /
   среднее 10-50кВт / тяжёлое 50-200кВт / крупное >200кВт)
6. supply_type: Предполагаемый тип питания (1-фазное 220В / 3-фазное 380В /
   3-фазное 400-690В / постоянный ток / пневматическое / другое)
7. notes: Любые особенности, важные для интерпретации параметров

Ответ — строго JSON-объект с этими 7 полями. Если не удаётся определить — пиши "не определено".
"""


def make_context_prompt(file_list: list[str]) -> str:
    """Сформировать user prompt для определения контекста оборудования."""
    files_str = ", ".join(f"«{f}»" for f in file_list)
    return f"""Определи тип и характеристики оборудования на основании
начальных страниц этих документов: {files_str}.
Заполни все 7 полей JSON."""


# =============================================================================
# ЭТАП 3: ИЗВЛЕЧЕНИЕ ПАРАМЕТРОВ
# =============================================================================

EXTRACTION_SYSTEM_PROMPT = """Ты — ведущий технический аналитик проектного института. Твоя задача — извлечь ВСЕ технические параметры оборудования из предоставленного фрагмента документации.

ПРАВИЛА:
1. Извлекай ТОЛЬКО данные, которые явно присутствуют в документе. Не домысливай.
2. Для каждого найденного параметра укажи:
   - value: значение с единицами измерения
   - page: номер страницы в этом фрагменте (1 = первая страница фрагмента)
   - section: название раздела/заголовка документа, где найдено значение
   - quote: цитата из оригинала (до 50 символов) — фрагмент текста, откуда взято значение
   - confidence: "high" если значение чёткое, "medium" если текст/скан среднего качества, "low" если плохо читается
3. Если параметр НЕ найден в этом фрагменте — НЕ включай его (оставь null).
4. Единицы измерения приводи к СИ. Оригинальные единицы — в скобках: "0,6 МПа (6 бар)".
5. Размеры: формат Д × Ш × В через " × " с пробелами. Единица в конце: "3 429 × 1 890 × 2 010 мм".
6. Десятичный разделитель: запятая. Разделитель тысяч: пробел. Пример: "5 800 кг".
7. Диапазоны: тире без пробелов. Пример: "0,3–0,5 МПа".
8. Давление: МПа, в скобках бар. Пример: "0,6 МПа (6 бар)".
9. Если есть режимы работы (пуск/работа/промывка) — перечисли через ";": "Пуск: 2,5 м³/ч; Работа: 1,8 м³/ч".
10. Перевод терминов: "[Переведённый термин] (Original Term)".
11. МНОЖЕСТВЕННЫЕ ЗНАЧЕНИЯ: Если для одного параметра есть несколько значений
    (например, напряжение питания 380 В И напряжение управления 220 В, или
    несколько двигателей с разной мощностью) — перечисляй ВСЕ через ";":
    "380 В (силовое питание); 220 В (цепи управления)".
    Для D.1 (мощность) — если в документе перечислены мощности отдельных приводов,
    укажи каждый И рассчитай суммарную: "Σ ≈ 42,6 кВт (шпиндель 30 + подачи 4,3+4,5 + ...)".
12. КРОСС-СЕКЦИОННЫЙ ПОИСК: Параметры групп D–H часто разбросаны по разным
    разделам документа. Например:
    - Давление сжатого воздуха (E.1) может быть в разделах «Смазка», «Охлаждение», «Пневмосистема»
    - Расход воды (F.3) может быть в разделах «Охлаждение», «СОЖ»
    - Мощности двигателей (D.1) могут быть в «Электрооборудование», «Приводы», «Спецификация»
    Ищи данные ВО ВСЁМ фрагменте, не только в разделе с подходящим заголовком.
13. ТОЧНОСТЬ СИМВОЛОВ ПРИ ЧТЕНИИ СКАНОВ:
    a) Путаница цифр и кириллицы: 0↔О, 1↔l↔I, П↔11, Б↔6, В↔8, З↔3
    b) Путаница ЦИФР на старых/нечётких сканах: 3↔5↔8, 6↔0, 1↔7.
       Особенно проверяй цифровые диапазоны (например, "30–80%", "3–5 МПа"):
       если первая цифра диапазона плохо читается — перечитай её внимательно.
    c) При подозрении — установи confidence="low" и добавь в note:
       "возможна ошибка OCR: символ [X] мог быть прочитан как [Y]"
       с указанием конкретных подозрительных символов.
    d) Индексы моделей: кириллическая буква среди цифр — вероятно ошибка распознавания.
14. КОНТЕКСТ ИЗВЛЕЧЕНИЯ: Группы B–H описывают ТРЕБОВАНИЯ К ПЛОЩАДКЕ/ЗДАНИЮ
    для размещения и подключения оборудования. Это данные, нужные ПРОЕКТИРОВЩИКУ
    (архитектору, электрику, сантехнику) для подготовки помещения:
    - D: Что подать от ВНЕШНЕЙ электросети на вводной щит оборудования
    - E: Что подать от ВНЕШНЕЙ пневмосети на вход оборудования
    - F: Что подать от ВНЕШНЕЙ водопроводной сети
    Если документ содержит и внешние (подключение к сетям здания), и внутренние
    (параметры внутренних узлов) значения — извлекай ВНЕШНИЕ, т.к. они нужны проектировщику.

ЧЕК-ЛИСТ ПАРАМЕТРОВ (A.1–H.4):

### A. Идентификация
A.1. Наименование и назначение
A.2. Модель / полный артикул
A.3. Производитель, страна, ссылка на сайт
A.4. Год выпуска и серийный номер. Если год выпуска не указан явно — ищи дату издания документации (на обложке, титульном листе) как приближение, с пометкой "дата издания документации" в note

### B. Габариты и логистика заноса
B.1. Габариты (Д×Ш×В, мм) — в рабочем и транспортном положении
B.2. Минимальный монтажный проём (Ш×В, мм)
B.3. Масса нетто и масса с жидкостями (кг). При наличии нескольких модификаций/комплектаций — указать вес КАЖДОЙ. Если вес указан по частям (корпус + конвейер + бак) — рассчитай суммарный
B.4. Масса тяжелейшей части при транспортировке (кг)
B.5. Точки строповки и центр тяжести

### C. Строительные требования (АС)
C.1. Тип установки: фундамент / виброопоры / анкерное крепление
C.2. Размеры фундамента или опорной рамы (Д×Ш×Г, мм)
C.3. Глубина приямков или высота подиума
C.4. Статические и динамические нагрузки
C.5. Зона обслуживания: мин. расстояния от стен / соседнего оборудования
C.6. Требования к полу: ровность, допуски, нагрузка на перекрытие
C.7. Требования к строительным конструкциям / отделке

### D. Электроснабжение и тепло (ЭМ / ОВ)
D.1. Суммарная установленная мощность P_уст (кВт) — сумма ВСЕХ двигателей/приводов, включая вспомогательные (АСИ, насосы СОЖ, гидростанция, конвейер стружки и т.д.). Если перечислены отдельные приводы — укажи КАЖДЫЙ и рассчитай Σ. Проверь таблицы полностью — не пропускай строки. Отдельно P_потр если указана.
D.2. ВСЕ напряжения внешнего питания: силовое (380 В) И управление (220 В) если различаются; фазность (3ф/1ф), частота (Гц), ток (А)
D.3. Категория надёжности электроснабжения (I, II, III), ИБП
D.4. Тип пуска, cos φ, Ки, компенсация реактивной мощности
D.5. Тепловыделения (кВт) — в воздух и в систему охлаждения
D.6. Степень защиты (IP), класс зоны
D.7. Тип заземления (TN-S, TN-C-S), точка подключения контура
D.8. Точка ввода кабеля: направление, координаты

### E. Сжатый воздух и газы (ТХ)
E.1. Давление сжатого воздуха на входе (МПа) — рабочее и пиковое. Искать во ВСЕХ разделах: пневматика, смазка, охлаждение, зажим
E.2. Расход (м³/ч или н.л/мин) — средний и максимальный
E.3. Качество среды: класс чистоты, масло, точка росы
E.4. Точка подключения: Ø, тип резьбы/фланца, координаты

### F. Водоснабжение и канализация (ВК)
F.1. Назначение воды (охлаждение, промывка, технологическая)
F.2. Требования к качеству воды
F.3. Расход воды, давление, температура
F.4. Точка подключения: Ø, тип соединения, координаты
F.5. Канализация: расход стоков, температура, состав
F.6. Точка слива: самотёк/давление, высота, Ø
F.7. СОЖ: объём системы, марка, сепарация
F.8. Периодичность потребления

### G. Вентиляция, экология и шум (ОВ)
G.1. Локальные отсосы: Ø патрубков, объём, разрежение
G.2. Состав выбросов: ПДК, температура газов, взрывоопасность
G.3. Уровень звукового давления (дБА) на расстоянии 1 м
G.4. Вибрация: уровни, виброизоляция

### H. Автоматизация и безопасность (АТХ / СС)
H.1. IT-инфраструктура: порты, протоколы
H.2. Интеграция в систему безопасности (E-Stop, блокировка)
H.3. Световая и звуковая сигнализация
H.4. Микроклимат: ВСЕ режимы — рабочий, рекомендуемый, хранение. Формат: "Рабочая: T°C, W% RH; Хранение: T°C, W% RH". Если один диапазон — уточни тип

ФОРМАТ ОТВЕТА — строго JSON-объект (НЕ массив!) с ключами ниже.
Для каждого найденного параметра — объект с полями value и source.
Ненайденные параметры — не включай (или null).

Ключи: a1_name, a2_model, a3_manufacturer, a4_year_serial,
b1_dimensions, b2_opening, b3_weight, b4_heaviest_part, b5_rigging,
c1_installation, c2_foundation, c3_pits, c4_loads, c5_service_zone, c6_floor, c7_construction,
d1_power, d2_voltage, d3_reliability, d4_startup, d5_heat, d6_protection, d7_grounding, d8_cable_entry,
e1_pressure, e2_flow, e3_quality, e4_connection,
f1_purpose, f2_quality, f3_flow, f4_connection, f5_drainage, f6_drain_point, f7_coolant, f8_periodicity,
g1_exhaust, g2_emissions, g3_noise, g4_vibration,
h1_it, h2_safety, h3_signaling, h4_climate.

Пример ответа:
{
  "a1_name": {
    "value": "Токарный станок с ЧПУ",
    "source": {"file": "passport.pdf", "doc_type": "Паспорт", "page": 1, "section": "Введение", "quote": "CNC Lathe", "confidence": "high"}
  },
  "a2_model": {
    "value": "CTX 450",
    "source": {"file": "passport.pdf", "doc_type": "Паспорт", "page": 1, "section": "Введение", "quote": "Model: CTX 450", "confidence": "high"}
  },
  "b3_weight": {
    "value": "5 800 кг",
    "source": {"file": "passport.pdf", "doc_type": "Паспорт", "page": 3, "section": "Характеристики", "quote": "Weight: 5800 kg", "confidence": "high"}
  }
}
"""


def make_extraction_prompt(source_file: str, source_type: str,
                           page_start: int | None, page_end: int | None,
                           equipment_context: str = "") -> str:
    """Сформировать user prompt для извлечения параметров из чанка."""
    page_info = ""
    if page_start is not None:
        if page_start == page_end:
            page_info = f"Это страница {page_start} файла «{source_file}»."
        else:
            page_info = f"Это страницы {page_start}–{page_end} файла «{source_file}»."
    else:
        page_info = f"Это файл «{source_file}»."

    context_block = ""
    if equipment_context:
        context_block = f"""
КОНТЕКСТ ОБОРУДОВАНИЯ (определён предварительным анализом):
{equipment_context}

Используй этот контекст для разрешения неоднозначностей при интерпретации параметров.
Например, если оборудование питается от 3-фазной сети 380В, а в документе встречается
напряжение 12В или 24В — это скорее всего внутренний источник питания (для управления,
датчиков), а НЕ параметр электроснабжения площадки (D.2).
Аналогично: если оборудование подключается к пневмосети, а в документе указан редуктор
с выходным давлением 0,2 МПа — это внутренний параметр; для D/E групп нужно давление
НА ВХОДЕ в оборудование (от магистрали здания).
Не пропускай параметры, явно указанные в документе — контекст лишь помогает
отличить внешние требования к подключению от внутренних параметров узлов.
"""

    return f"""{page_info}
Тип документа: {source_type}.
{context_block}
Извлеки ВСЕ технические параметры оборудования из этого фрагмента по чек-листу A.1–H.4.
Для каждого найденного параметра заполни: value, page (номер страницы в ЭТОМ фрагменте, начиная с 1), section, quote, confidence.
Параметры, которых НЕТ в этом фрагменте — оставь null.
Помни: номер страницы в поле "page" — это номер страницы ВНУТРИ этого фрагмента (1 = первая страница фрагмента)."""


VERIFICATION_SYSTEM_PROMPT = """Ты — ведущий технический аналитик проектного института. Тебе предоставлены:
1. Агрегированные данные из карточки оборудования (JSON).
2. Исходные документы.

Твои задачи:
1. ПРОВЕРКА ПОЛНОТЫ: Какие параметры из чек-листа A.1–H.4 отсутствуют? Есть ли данные, которые были пропущены при первичном извлечении?
2. ПРОВЕРКА КОНФЛИКТОВ: Есть ли противоречия между значениями из разных источников?
3. КОСВЕННЫЕ ПАРАМЕТРЫ: Есть ли параметры, которые можно вывести косвенно? Например:
   - "охлаждение шпинделя" → требуется водоснабжение (группа F)
   - "гидравлическая станция" → требуется слив масла (группа F)
   - "ЧПУ" → требуется IT-подключение (группа H)
4. ПРОВЕРКА ССЫЛОК: Корректны ли привязки значений к страницам документов?
5. ПРОВЕРКА ЛОГИЧЕСКОЙ НЕПРОТИВОРЕЧИВОСТИ:
   - Мощность (D.1) и напряжение (D.2) должны быть совместимы (энергетически реалистичны).
   - Параметры групп D–F должны описывать ВНЕШНИЕ подключения к сетям здания
     (что подать от сети), а не внутренние узлы оборудования (блоки питания,
     внутренние редукторы и т.п.). Если обнаружена путаница — найди и предложи
     правильное значение через additional_values.
6. ПРОВЕРКА ПОЛНОТЫ ЗНАЧЕНИЙ:
   - D.1: Если указана только мощность одного привода, а в документах перечислены
     несколько двигателей — рассчитай суммарную установленную мощность и добавь
     через additional_values.
   - D.2: Если указано одно напряжение, но в документе есть несколько питающих
     цепей (силовое + управление) — добавь все через additional_values.
   - E.1: Если указано «нет данных», но в документе есть давление воздуха
     в разделах смазки/охлаждения/пневмоаппаратуры — извлеки и добавь.
   - H.4: Если указан только один диапазон влажности — проверь, нет ли в документе
     другого (рабочий vs. рекомендуемый vs. хранение). Приоритет — рабочий диапазон.
7. ПРОВЕРКА ВОЗМОЖНЫХ ОШИБОК OCR:
   - Для значений с confidence="low" или note, содержащим "OCR" — перечитай
     соответствующее место в документе и сравни с извлечённым значением.
   - Для числовых диапазонов (X–Y): проверь, что нижняя граница < верхней
     и обе правдоподобны для данного параметра.
   - Если найдена вероятная ошибка — добавь исправление в corrections:
     {"field": "h4_climate", "issue": "OCR: '5' вероятно '3' (50→30)", "corrected_value": "..."}
8. ПРОВЕРКА ПОЛНОТЫ СУММИРОВАНИЯ:
   - D.1: Пересчитай суммарную мощность по ВСЕМ строкам таблицы двигателей,
     включая вспомогательные приводы (АСИ, насосы, конвейеры). Сравни с извлечённой Σ.
   - B.3: Если есть модификации — проверь, что указан полный вес (не только корпус).

Формат ответа — JSON:
{
  "missing_params": [{"field": "d5_heat", "suggestion": "Возможно указано на стр. 15 руководства"}],
  "conflicts": [{"field": "b3_weight", "values": ["5800 кг (паспорт)", "5750 кг (руководство)"]}],
  "indirect_params": [{"field": "f1_purpose", "reasoning": "Указано охлаждение шпинделя → нужна вода", "suggested_value": "Охлаждение шпинделя"}],
  "corrections": [{"field": "d2_voltage", "issue": "Номер страницы некорректен", "corrected_page": 14}, {"field": "h4_climate", "issue": "OCR: '5' вероятно '3' (50→30)", "corrected_value": "Рабочая: 20°C, 30–80% RH"}],
  "additional_values": [{"field": "e3_quality", "value": "Класс 1.4.1 по ISO 8573-1", "page": 18, "section": "Пневмосистема", "quote": "Air quality class 1.4.1", "file": "passport.pdf"}]
}
"""


def make_verification_prompt(aggregated_json: str,
                             equipment_context: str = "") -> str:
    """Сформировать промпт для верификации агрегированных данных."""
    context_block = ""
    if equipment_context:
        context_block = f"""
КОНТЕКСТ ОБОРУДОВАНИЯ:
{equipment_context}

Используй контекст для проверки логической непротиворечивости:
- Параметры D–F должны описывать ВНЕШНИЕ подключения (от сетей здания),
  а не внутренние узлы оборудования.
- Если тип питания — 3-фазное 380В, а в D.2 указано 12В — это ошибка.
- Если оборудование подключается к пневмосети, а в E.1 указано давление
  внутреннего редуктора — нужно найти входное давление магистрали.
"""

    return f"""Вот агрегированные данные карточки оборудования:

{aggregated_json}
{context_block}
Проверь эти данные по исходным документам (приложены).
Выполни все 8 задач: полнота, конфликты, косвенные параметры, проверка ссылок,
логическая непротиворечивость, полнота значений, ошибки OCR, полнота суммирования.
Если нашёл дополнительные значения — добавь в additional_values с полной ссылкой на источник."""
